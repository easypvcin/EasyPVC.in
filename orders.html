<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Orders</title>

  <!-- Firebase Auth Logic -->
  <script type="module" src="./js/auth.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { firebaseConfig } from "./js/firebase.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    function showLoader() {
      document.getElementById("loader").style.display = "block";
    }

    function hideLoader() {
      document.getElementById("loader").style.display = "none";
    }

    function showError(message) {
      const errorElem = document.getElementById("errorMessage");
      errorElem.textContent = message;
      errorElem.style.display = "block";
    }

    function fetchOrders() {
      showLoader();

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          hideLoader();
          showError("‚ö†Ô∏è Please login to view your orders.");
          return;
        }

        try {
          const ordersQuery = query(
            collection(db, "orders"),
            where("uid", "==", user.uid)
          );
          const querySnapshot = await getDocs(ordersQuery);
          hideLoader();

          if (querySnapshot.empty) {
            showError("‚ùå No orders found!");
            return;
          }

          let ordersHTML = "";
          querySnapshot.forEach((doc) => {
            const order = doc.data();

            let fileHTML = "";
            if (order.image1 && order.image2) {
              fileHTML = `
                <div class="image-container">
                  <img src="${order.image1}" alt="Order Image 1" class="order-img">
                  <img src="${order.image2}" alt="Order Image 2" class="order-img">
                </div>`;
            } else if (order.image1) {
              fileHTML = `<img src="${order.image1}" alt="Order Image" class="order-img single">`;
            } else if (order.pdfUrl) {
              fileHTML = `<a href="${order.pdfUrl}" target="_blank" class="btn view-btn">üìÑ View Uploaded PDF</a>`;
            } else {
              fileHTML = `<p style="color: red;">No file uploaded.</p>`;
            }

            ordersHTML += `
              <div class="order-card" data-order-id="${doc.id}">
                ${fileHTML}
                <div class="order-details">
                  <p><strong>Order ID:</strong> ${doc.id}</p>
                  <p><strong>Name:</strong> ${order.name}</p>
                  <p><strong>Price:</strong> ${order.price}</p>
                  <p><strong>Address:</strong> ${order.address}, ${order.city}, ${order.state}, ${order.pincode}</p>
                  <p><strong>Mobile:</strong> ${order.mobile}</p>
                  <p><strong>Payment ID:</strong> ${order.paymentId}</p>
                  <p><strong>Status:</strong> ${order.status}</p>
                </div>
                <button class="btn" onclick="downloadReceipt('${doc.id}')">üìÑ Download Receipt</button>
              </div>`;
          });

          document.getElementById("ordersContainer").innerHTML = ordersHTML;

        } catch (error) {
          hideLoader();
          showError("‚ùå Error loading orders: " + error.message);
        }
      });
    }

    window.downloadReceipt = function(orderId) {
      const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);

      if (!orderCard) {
        alert("‚ùå Order not found!");
        return;
      }

      alert("Generating your receipt PDF. Please wait...");

      const clonedCard = orderCard.cloneNode(true);
      clonedCard.style.width = "100%";
      clonedCard.style.padding = "20px";
      clonedCard.style.fontSize = "16px";

      const container = document.createElement("div");
      container.style.width = "600px";
      container.style.margin = "auto";
      container.style.background = "#fff";
      container.style.padding = "20px";
      container.appendChild(clonedCard);

      const options = {
        margin: 10,
        filename: `Receipt_${orderId.replace(/[^\w\s]/gi, '_')}.pdf`,
        image: { type: "jpeg", quality: 1.0 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      html2pdf().from(container).set(options).save();
    };

    document.getElementById("logoutBtn")?.addEventListener("click", () => {
      signOut(auth).then(() => {
        alert("‚úÖ Logged out successfully!");
        window.location.href = "login.html";
      }).catch((error) => {
        alert("‚ùå Error logging out: " + error.message);
      });
    });

    window.onload = fetchOrders;
  </script>

  <script>
    function toggleMenu() {
      let nav = document.querySelector(".nav-links");
      let menuIcon = document.querySelector(".menu-icon");
      if (nav.style.height === "0px" || nav.style.height === "") {
        nav.style.height = nav.scrollHeight + "px";
        menuIcon.innerHTML = "‚úñ";
      } else {
        nav.style.height = "0px";
        menuIcon.innerHTML = "‚ò∞";
      }
    }
  </script>

  <link rel="stylesheet" href="./css/orders.css" type="text/css" media="all" />
</head>

<body>
  <nav class="navbar">
    <div class="logo">
      <img src="./img/logo.png" alt="Print 420 Logo">
      <span id="userEmail" style="display:none; font-weight: bold;"></span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="index.html#services">Services</a></li>
      <li><a href="about.html">About Us</a></li>
      <li><a href="orders.html">Orders</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="login.html" id="loginBtn">Login</a></li>
      <li><a href="#" id="logoutBtn" style="display: none;">Logout</a></li>
      <li><a href="signup.html" id="signupBtn">Signup</a></li>
    </ul>
    <div class="menu-icon" onclick="toggleMenu()">‚ò∞</div>
  </nav>

  <div style="height: 100px;" class="gap"></div>

  <h1>Your Orders</h1>
  <div id="loader" class="loader" style="display: none;">Loading...</div>
  <p id="errorMessage" class="error" style="display: none;"></p>
  <div class="orders-container" id="ordersContainer"></div>

  <div class="footer-bottom">
    <p>&copy; 2025 Print 420. All Rights Reserved.</p>
  </div>
</body>
</html>