<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="./css/orders.css" type="text/css" media="all" />
  <title>Your Orders</title>
  <style>
      * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }  

        body { background: #f8f8f8; color: #d40000; } 
        body {
            font-family: Arial, sans-serif;
            background-color: #fff;
            color: #d40000;
            text-align: center;
            padding: 20px;
        }
                 

                /* Navbar */

        .navbar { 
            position: fixed; 
            top: 0; left: 0; width: 100%; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 10%; background: white; 
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1); 
            z-index: 1000;
        }
 
        .navbar {
    border-bottom: 1px solid #FF0000;  /* Change color as needed */
}
        .logo img { height: 40px; }

        .nav-links { 
            list-style: none; 
            display: flex; gap: 20px; 
        }
        .nav-links li { display: inline; }
        .nav-links a { 
            color: #333; text-decoration: none; font-size: 16px; font-weight: bold; 
        }
        .btn-login { 
            background: #FF0000; padding: 8px 15px; 
            border-radius: 5px; color: white; 
            text-decoration: none; font-weight: bold; 
        }

        /* Hamburger Menu */
        .menu-icon {
            display: none;
            font-size: 24px;
            cursor: pointer;
        }

        /* Mobile Navigation */
        @media (max-width: 768px) {
            .menu-icon { display: block; position: relative; z-index: 1100; }
            
            .nav-links { 
                position: absolute; top: 75px; right: 0; 
                background: white; width: 100%; 
                flex-direction: column; 
                text-align: center; padding: 0;
                box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
                
                /* Initially hidden */
                height: 0;
                overflow: hidden;
                transition: height 0.5s ease-in-out;
            }
            .nav-links.active { height: auto; padding: 10px 0; }
            
            .nav-links li { padding: 10px; border-bottom: 1px solid #ddd; }
        }
       
       
#userEmail {
    max-width: 180px;  /* ✅ Increased width */
    overflow: hidden;  
    text-overflow: ellipsis; /* ✅ Shows "..." when text overflows */
    white-space: nowrap;  
    display: inline-block;
    font-size: 16px; /* ✅ Slightly bigger text */
    font-weight: 500;
    vertical-align: middle;
    padding: 0 10px; /* ✅ Add some spacing */
}
        h1 {
            color: #d40000;
        }

        .orders-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .order-card {
            background: #fff;
            border: 2px solid #d40000;
            border-radius: 8px;
            padding: 15px;
            width: 300px;
            box-shadow: 0px 4px 10px rgba(212, 0, 0, 0.3);
            transition: transform 0.3s ease-in-out;
        }
        .order-card:hover {
            transform: scale(1.05);
        }
        .image-container {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .order-img {
            width: 48%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }
        .order-img.single {
            width: 50%;
        }
        .order-details {
            text-align: left;
            padding: 10px;
            color: black;
        }
        .btn {
            padding: 8px;
            background: #d40000;
            color: white;
            border: none;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .btn:hover {
            background: #a00000;
        }

    /* Bottom Footer */
    .footer-bottom {
        margin-top: 30px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 0, 0, 0.3);
    }

    .footer-bottom p {
        font-size: 14px;
        color: #333;
        text-align: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .footer-container {
            flex-direction: column;
            text-align: left;
        }

        .footer-section {
            text-align: left;
        }

        .social-icons {
            justify-content: left;
        }
    }

    @media (max-width: 600px) {
        .footer-intro h2 {
            font-size: 24px;
        }
        .footer-intro p {
            font-size: 16px;
        }
    }
    .loader { display: none; text-align: center; margin: 20px; }

    .skeleton-loader {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .skeleton-card {
      height: 150px;
      background: linear-gradient(-90deg, #e0e0e0 0%, #f8f8f8 50%, #e0e0e0 100%);
      background-size: 400% 400%;
      animation: shimmer 1.2s ease-in-out infinite;
      border-radius: 8px;
    }
    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }
    .order-card { border: 1px solid #ccc; margin: 20px 0; padding: 20px; border-radius: 8px; }
    .order-img { max-width: 100%; margin: 10px 0; }
    .order-img.single { width: 100%; }
    .btn { padding: 10px 15px; margin-top: 10px; cursor: pointer; background-color: #007BFF; color: white; border: none; border-radius: 5px; }
    .pdf-container iframe { width: 100%; height: 500px; margin-top: 10px; border: 1px solid #ccc; }
    input#searchInput { padding: 10px; width: 100%; margin: 20px 0; border: 1px solid #ccc; border-radius: 4px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { firebaseConfig } from "./js/firebase.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    function showLoader() {
      document.getElementById("loader").style.display = "block";
      document.getElementById("skeletonLoader").style.display = "flex";
    }

    function hideLoader() {
      document.getElementById("loader").style.display = "none";
      document.getElementById("skeletonLoader").style.display = "none";
    }

    function showError(message) {
      const errorElem = document.getElementById("errorMessage");
      errorElem.textContent = message;
      errorElem.style.display = "block";
    }

    function filterOrders() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const orders = document.getElementsByClassName("order-card");
      Array.from(orders).forEach((order) => {
        const name = order.querySelector(".order-details p:nth-child(2)").textContent.toLowerCase();
        const orderId = order.getAttribute("data-order-id").toLowerCase();
        order.style.display = name.includes(input) || orderId.includes(input) ? "" : "none";
      });
    }

    function fetchOrders() {
      showLoader();
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          hideLoader();
          showError("⚠️ Please login to view your orders.");
          return;
        }

        try {
          const ordersQuery = query(collection(db, "orders"), where("uid", "==", user.uid));
          const querySnapshot = await getDocs(ordersQuery);
          hideLoader();

          if (querySnapshot.empty) {
            showError("❌ No orders found!");
            return;
          }

          let ordersHTML = "";
          querySnapshot.forEach((doc) => {
            const order = doc.data();
            let fileHTML = "";

            if (order.image1 && order.image2) {
              fileHTML = `<div class="image-container">
                <img src="${order.image1}" alt="Order Image 1" class="order-img">
                <img src="${order.image2}" alt="Order Image 2" class="order-img">
              </div>`;
            } else if (order.image1) {
              fileHTML = `<img src="${order.image1}" alt="Order Image" class="order-img single">`;
            } else if (order.pdfUrl) {
              fileHTML = `<div class="pdf-container">
                <iframe src="${order.pdfUrl}"></iframe>
              </div>`;
            } else {
              fileHTML = `<p style="color: red;">No file uploaded.</p>`;
            }

            ordersHTML += `
              <div class="order-card" data-order-id="${doc.id}">
                ${fileHTML}
                <div class="order-details">
                  <p><strong>Order ID:</strong> ${doc.id}</p>
                  <p><strong>Name:</strong> ${order.name}</p>
                  <p><strong>Price:</strong> ${order.price}</p>
                  <p><strong>Address:</strong> ${order.address}, ${order.city}, ${order.state}, ${order.pincode}</p>
                  <p><strong>Mobile:</strong> ${order.mobile}</p>
                  <p><strong>Payment ID:</strong> ${order.paymentId}</p>
                  <p><strong>Status:</strong> ${order.status}</p>
                </div>
                <button class="btn" onclick="downloadReceipt('${doc.id}')">📄 Download Receipt</button>
              </div>`;
          });

          document.getElementById("ordersContainer").innerHTML = ordersHTML;
        } catch (error) {
          hideLoader();
          showError("❌ Error loading orders: " + error.message);
        }
      });
    }

    window.downloadReceipt = function(orderId) {
      const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
      if (!orderCard) {
        alert("❌ Order not found!");
        return;
      }

      alert("Generating your receipt PDF. Please wait...");

      const clonedCard = orderCard.cloneNode(true);
      clonedCard.style.width = "100%";
      clonedCard.style.padding = "20px";
      clonedCard.style.fontSize = "16px";

      const container = document.createElement("div");
      container.style.width = "600px";
      container.style.margin = "auto";
      container.style.background = "#fff";
      container.style.padding = "20px";

      const logo = document.createElement("img");
      logo.src = "./img/logo.png";
      logo.alt = "Print 420 Logo";
      logo.style.width = "150px";
      logo.style.marginBottom = "20px";
      container.appendChild(logo);
      container.appendChild(clonedCard);

      html2pdf().from(container).set({
        margin: 10,
        filename: `Receipt_${orderId.replace(/[^\w\s]/gi, '_')}.pdf`,
        image: { type: "jpeg", quality: 1.0 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      }).save();
    };

    window.onload = fetchOrders;

    document.getElementById("logoutBtn")?.addEventListener("click", () => {
      signOut(auth).then(() => {
        alert("✅ Logged out successfully!");
        window.location.href = "login.html";
      }).catch((error) => {
        alert("❌ Error logging out: " + error.message);
      });
    });
  </script>
</head>

<body>
<!-- ✅ Navbar -->
<nav class="navbar">
  <div class="logo">
    <img src="./img/logo.png" alt="Print 420 Logo">
    <span id="userEmail" style="display:none; font-weight: bold;"></span>
  </div>
  <ul class="nav-links">
    <li><a href="index.html">Home</a></li>
    <li><a href="index.html#services">Services</a></li>
    <li><a href="about.html">About Us</a></li>
    <li><a href="orders.html">Orders</a></li>
    <li><a href="contact.html">Contact</a></li>
    <li id="authLinks">
      <a href="login.html" id="loginBtn">Login</a>
      <a href="#" id="logoutBtn" style="display: none;">Logout</a>
      <a href="signup.html" id="signupBtn">Signup</a>
    </li>
  </ul>
  <div class="menu-icon" onclick="toggleMenu()">☰</div>
</nav>

  <h1>Your Orders</h1>

  <input type="text" id="searchInput" placeholder="Search by name or Order ID" onkeyup="filterOrders()" />

  <div id="loader" class="loader">Loading...</div>
  <div id="skeletonLoader" class="skeleton-loader" style="display: none;">
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
  </div>

  <p id="errorMessage" class="error" style="color: red; display: none;"></p>
  <div class="orders-container" id="ordersContainer"></div>

  <footer>
    <p style="text-align: center;">&copy; 2025 Print 420. All Rights Reserved.</p>
  </footer>
  <script type="module" src="./js/auth.js">./js/auth.js</script>
</body>
</html>
